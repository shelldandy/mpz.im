---
import { getCollection, getEntry } from 'astro:content';
import type { GetStaticPaths, Page as AstroPage } from 'astro';
import Page from '../../layouts/Page.astro';
import BlogPostCard from '../../components/BlogPostCard';
import Pagination from '../../components/Pagination';

// Helper function to generate excerpt from post body
function generateExcerpt(body: string, length: number): string {
  // Strip markdown and HTML
  const cleanText = body
    .replace(/^---[\s\S]*?---/, '') // Remove frontmatter
    .replace(/```[\s\S]*?```/g, '') // Remove code blocks
    .replace(/#{1,6}\s/g, '') // Remove markdown headers
    .replace(/^>\s+/gm, '') // Remove blockquotes
    .replace(/^[-*+]\s+/gm, '') // Remove unordered list markers
    .replace(/^\d+\.\s+/gm, '') // Remove ordered list markers
    .replace(/!\[([^\]]*)\]\([^)]+\)/g, '$1') // Convert images to alt text
    .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // Convert links to text
    .replace(/[*_~`]/g, '') // Remove markdown formatting
    .replace(/<[^>]+>/g, '') // Remove HTML tags
    .replace(/\n{2,}/g, ' ') // Replace multiple newlines with space
    .replace(/\s+/g, ' ') // Normalize whitespace
    .trim();

  // Truncate to length
  if (cleanText.length <= length) {
    return cleanText;
  }

  const truncated = cleanText.substring(0, length);
  const lastSpace = truncated.lastIndexOf(' ');
  return lastSpace > 0 ? truncated.substring(0, lastSpace) + '...' : truncated + '...';
}

export const getStaticPaths = (async ({ paginate }) => {
  const allPosts = await getCollection('posts');
  const sortedPosts = allPosts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

  return paginate(sortedPosts, { pageSize: 10 });
}) satisfies GetStaticPaths;

const postsPage = await getEntry('pages', 'posts');
const { Content } = await postsPage.render();
const { title, hero } = postsPage.data;

const { page } = Astro.props;
---

<Page title={title} hero={hero}>
  <Content />

  <div class="posts-list">
    {page.data.map((post) => {
      const excerpt = post.data.excerpt || generateExcerpt(post.body, post.data.excerptLength || 200);
      return (
        <BlogPostCard
          title={post.data.title}
          date={post.data.date}
          slug={post.slug}
          excerpt={excerpt}
          client:load
        />
      );
    })}
  </div>

  <Pagination page={page} client:load />
</Page>

<style>
  .posts-list {
    margin-top: 2rem;
  }
</style>
