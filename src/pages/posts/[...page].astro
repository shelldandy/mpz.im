---
import { getCollection, getEntry } from 'astro:content';
import type { GetStaticPaths, Page as AstroPage } from 'astro';
import Page from '../../layouts/Page.astro';
import BlogPostCard from '../../components/BlogPostCard';
import Pagination from '../../components/Pagination';

const DEFAULT_EXCERPT_LENGTH = 150;

function generateExcerpt(content: string, length: number): string {
  // Strip markdown/HTML and get plain text
  const plainText = content
    .replace(/!\[.*?\]\(.*?\)/g, '') // Remove images
    .replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1') // Convert links to text
    .replace(/[#*_`~]/g, '') // Remove markdown formatting
    .replace(/<[^>]*>/g, '') // Remove HTML tags
    .trim();

  // Truncate to specified length
  if (plainText.length <= length) {
    return plainText;
  }

  // Find the last space before the length limit to avoid cutting words
  const truncated = plainText.substring(0, length);
  const lastSpace = truncated.lastIndexOf(' ');

  return lastSpace > 0
    ? truncated.substring(0, lastSpace) + '...'
    : truncated + '...';
}

export const getStaticPaths = (async ({ paginate }) => {
  const allPosts = await getCollection('posts');
  const sortedPosts = allPosts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

  return paginate(sortedPosts, { pageSize: 10 });
}) satisfies GetStaticPaths;

const postsPage = await getEntry('pages', 'posts');
const { Content } = await postsPage.render();
const { title, hero } = postsPage.data;

const { page } = Astro.props;

// Generate excerpts for each post
const postsWithExcerpts = await Promise.all(
  page.data.map(async (post) => {
    let excerpt = post.data.excerpt;

    // If no custom excerpt is provided, generate from content
    if (!excerpt) {
      const { body } = post;
      const excerptLength = post.data.excerptLength || DEFAULT_EXCERPT_LENGTH;
      excerpt = generateExcerpt(body, excerptLength);
    }

    return {
      ...post,
      excerpt,
    };
  })
);
---

<Page title={title} hero={hero}>
  <Content />

  <div class="posts-list">
    {postsWithExcerpts.map((post) => (
      <BlogPostCard
        title={post.data.title}
        date={post.data.date}
        slug={post.slug}
        excerpt={post.excerpt}
        client:load
      />
    ))}
  </div>

  <Pagination page={page} client:load />
</Page>

<style>
  .posts-list {
    margin-top: 2rem;
  }
</style>
